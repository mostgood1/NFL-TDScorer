{% set showModal = true %}
<style>
  /* Layout tweaks for player cards */
  .player-card-left img.player-img-lg { width:100%; max-width:110px; border-radius:8px; }
  .player-card-left .player-avatar { width:100%; max-width:110px; height:110px; display:flex; align-items:center; justify-content:center; font-size:34px; border-radius:8px; }
  .stat-grid { display:flex; flex-wrap:wrap; gap:6px; font-size:0.7rem; }
  .stat-grid div { background:#f4f5f7; padding:4px 6px; border-radius:4px; }
  .badge + .badge { margin-left:4px; }
</style>
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <form class="row g-2" method="get" action="/ui/players">
      <input type="hidden" name="tab" value="players" />
      <div class="col-auto">
        <label class="form-label">Season</label>
        <input class="form-control" name="season" value="{{ season }}" />
      </div>
      <div class="col-auto">
        <label class="form-label">Week</label>
        <input class="form-control" name="week" value="{{ week }}" />
      </div>
      <div class="col-auto">
        <label class="form-label">Position</label>
        <select class="form-select" name="pos">
          {% set pf = (pos|default('ALL')|upper) %}
          {% for opt in ['ALL','RB','WR','TE','QB'] %}
            <option value="{{ opt }}" {{ 'selected' if pf == opt else '' }}>{{ opt }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Team</label>
        <select class="form-select" name="team">
          {% set tf = team|default('ALL') %}
          <option value="ALL" {{ 'selected' if tf == 'ALL' else '' }}>ALL</option>
          {% for t in (teams or []) %}
            <option value="{{ t }}" {{ 'selected' if tf == t else '' }}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Game</label>
        <select class="form-select" name="game">
          {% set gf = game|default('ALL') %}
          <option value="ALL" {{ 'selected' if gf == 'ALL' else '' }}>ALL</option>
          {% for g in (games or []) %}
            <option value="{{ g.value }}" {{ 'selected' if gf == g.value else '' }}>{{ g.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Sort by</label>
        <select class="form-select" name="sort">
          {% set sb = (sort|default('atd')|lower) %}
          {% set options = [
            ['atd','ATD % (desc)'],
            ['adj_exp_td','Expected TD (desc)'],
            ['adj_exp_rush_td','Rush TD (desc)'],
            ['adj_exp_rec_td','Rec TD (desc)'],
            ['td24','2024 Total TD (desc)'],
            ['career_total','Career Total TD (desc)'],
            ['team','Team (A→Z)'],
            ['player','Player (A→Z)'],
            ['depth','Depth (asc)']
          ] %}
          {% for val,label in options %}
            <option value="{{ val }}" {{ 'selected' if sb == val else '' }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto align-self-end">
        <button class="btn btn-primary">Load</button>
      </div>
      <div class="col-auto align-self-end">
        <a class="btn btn-outline-secondary" href="/ui?tab=teams&season={{ season }}&week={{ week }}">View Teams</a>
      </div>
    </form>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
  {% for c in cards %}
  <div class="col">
    <div class="card shadow-sm">
      <div class="card-body p-2">
        <div class="row g-2 align-items-stretch">
          <!-- Left 25% -->
          <div class="col-3 player-card-left text-center d-flex flex-column align-items-center">
            {% if c.headshot %}
              <img class="player-img-lg" src="{{ c.headshot }}" alt="{{ c.player }}" />
            {% elif c.logo_url %}
              <img class="player-img-lg" src="{{ c.logo_url }}" alt="{{ c.team }} logo" />
            {% else %}
              <div class="player-avatar {{ c.team_class }}">{{ c.team_abbr }}</div>
            {% endif %}
            <div class="fw-bold small mt-2 text-truncate" style="max-width:110px;">{{ c.player }}</div>
            <div class="text-muted small">{{ c.pos }}{% if c.depth_label %} · {{ c.depth_label }}{% endif %}</div>
            <div class="small d-flex align-items-center justify-content-center gap-1">
              {% if c.logo_url %}
                <img class="team-logo-sm" src="{{ c.logo_url }}" alt="{{ c.team }} logo" style="height:20px;width:20px;object-fit:contain;" />
              {% else %}
                <span>{{ c.team_abbr }}</span>
              {% endif %}
              <span>{% if c.is_home %}vs{% else %}@{% endif %}</span>
              {% if c.opp_logo_url %}
                <img class="team-logo-sm" src="{{ c.opp_logo_url }}" alt="{{ c.opp }} logo" style="height:20px;width:20px;object-fit:contain;" />
              {% else %}
                <span>{{ c.opp_abbr }}</span>
              {% endif %}
            </div>
          </div>
          <!-- Right 75% -->
          <div class="col-9 d-flex flex-column">
            <div class="d-flex justify-content-end mb-1 flex-wrap gap-1"><!-- Value badge threshold >=20pp edge -->
              <span class="badge text-bg-primary">ATD {{ (c.atd*100)|fmt2 }}%</span>
              {% if c.bovada_american is not none %}<span class="badge text-bg-dark">{{ c.bovada_american }}</span>{% endif %}
              {% if c.atd_edge_pct is not none and c.atd_edge_pct >= 20 %}<span class="badge text-bg-success">Value</span>{% endif %}
              {% if c.td_scored %}<span class="badge text-bg-danger">TD</span>{% endif %}
            </div>
            <!-- Line 1: game/player expected values -->
            <div class="small mb-1 text-center"><strong>Exp</strong> {{ c.adj_exp_td|fmt2 }} · Rush {{ c.adj_exp_rush_td|fmt2 }} · Rec {{ c.adj_exp_rec_td|fmt2 }}{% if c.game_exp_tds_adj is not none %} · Team {{ c.game_exp_tds_adj|fmt2 }}{% endif %}</div>
            <!-- Line 2: current + last season -->
            <div class="small mb-1 text-center"><strong>2025</strong> TD {{ c.td_2025 }}{% if c.td24_total is not none %} · <strong>2024</strong> {{ c.td24_total }} (R {{ c.td24_rush }}, Rec {{ c.td24_rec }}){% endif %}</div>
            <!-- Line 3: career -->
            <div class="small mb-1 text-center"><strong>Career</strong> {{ c.career_total }} (R {{ c.career_rush }}, Rec {{ c.career_rec }})</div>
            <div class="mt-auto d-flex justify-content-end">
              <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal_{{ loop.index }}">Details</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modal_{{ loop.index }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ c.player }} — Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <h6>Context</h6>
              <ul class="small">
                <li>Matchup: {{ c.team }} vs {{ c.opp }} {{ '(home)' if c.is_home else '(away)' }}</li>
                <li>Projected team TDs: {{ c.game_exp_tds_adj if c.game_exp_tds_adj is not none else 'n/a' }}</li>
                <li>Expected TD (any): {{ c.adj_exp_td|fmt2 }} (Rush {{ c.adj_exp_rush_td|fmt2 }}, Rec {{ c.adj_exp_rec_td|fmt2 }})</li>
                {% if c.bovada_implied is not none %}
                <li>Bovada implied: {{ (c.bovada_implied*100)|fmt2 }}% {% if c.atd_edge_pct is not none %}(edge {{ c.atd_edge_pct }} pp){% endif %}</li>
                {% endif %}
                {% if c.td24_total is not none %}
                <li>2024 TDs: Rush {{ c.td24_rush }}, Rec {{ c.td24_rec }}, Total {{ c.td24_total }}</li>
                {% endif %}
              </ul>
            </div>
            <div class="col-md-6">
              <h6>Signals used</h6>
              <ul class="small">
                <li>Market implied team points (converted to expected TDs)</li>
                <li>EPA, pace, weather adjustments</li>
                <li>Team position TD shares (last 5y)</li>
                <li>Opponent position TDs allowed (last 5y) — small overlay</li>
                <li>Roster-informed usage (depth, FB caps)</li>
                <li>Historic player TDs (within-position nudge; 5y)</li>
                <li>2024 per-player TD totals (stronger within-position prior)</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if live_meta is defined %}
<div class="mt-3 d-flex justify-content-between align-items-center small text-muted">
  <div>Live TD tracked: {{ live_meta.count|default(0) }}{% if live_meta.age is not none %} (age: {{ live_meta.age|fmt2 }}s){% endif %}{% if live_meta.last %} • last fetch {{ live_meta.last }}{% endif %}</div>
  {% if (env and (env.get('TD_ADMIN')|default('')|lower in ['1','true','yes'])) %}
  <form method="post" action="/admin/refresh-live-tds?season={{ season }}&week={{ week }}" onsubmit="setTimeout(()=>location.reload(),300);">
    <button class="btn btn-sm btn-outline-danger">Admin: Refresh live TDs now</button>
  </form>
  {% endif %}
  
</div>
{% endif %}
